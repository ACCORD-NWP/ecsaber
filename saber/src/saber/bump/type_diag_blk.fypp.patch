--- /home/benjaminm/code/oops-bundle/ecsaber/saber/src/saber/bump/type_diag_blk.fypp.tmp	2024-04-15 14:43:59.709840616 +0200
+++ /home/benjaminm/code/oops-bundle/ecsaber/saber/src/saber/bump/type_diag_blk.fypp	2024-04-15 12:15:48.815441399 +0200
@@ -857,7 +857,7 @@
 ! Subroutine: diag_blk_localization
 !> Diag_blk localization
 !----------------------------------------------------------------------
-subroutine diag_blk_localization(diag_blk,mpl,nam,geom,avg_blk)
+subroutine diag_blk_localization(diag_blk,mpl,nam,geom,avg_blk,ne)
 
 implicit none
 
@@ -867,9 +867,11 @@
 type(nam_type),intent(in) :: nam               !< Namelist
 type(geom_type),intent(in) :: geom             !< Geometry
 type(avg_blk_type),intent(in) :: avg_blk       !< Averaged statistics block
+integer,intent(in) :: ne                       !< Ensemble size
 
 ! Local variables
 integer :: il0,jl0r,jc3,jc4
+real(kind_real) :: P4
 
 ! Set name
 @:set_name(diag_blk_localization)
@@ -877,19 +879,34 @@
 ! Probe in
 @:probe_in()
 
+! Ensemble size-dependent coefficient
+P4 = one/real(ne-1,kind_real)
+
 !$omp parallel do schedule(static) private(il0,jl0r,jc3,jc4) shared(geom,diag_blk,avg_blk)
 do il0=1,geom%nl0
    do jl0r=1,nam%nl0r
       do jc4=1,nam%nc4
          do jc3=1,nam%nc3
-            if (mpl%msv%isnot(avg_blk%m11asysq(jc3,jc4,jl0r,il0)).and.mpl%msv%isnot(avg_blk%m11sq(jc3,jc4,jl0r,il0))) then
-               ! Compute localization
-               diag_blk%raw(jc3,jc4,jl0r,il0) = avg_blk%m11asysq(jc3,jc4,jl0r,il0)/avg_blk%m11sq(jc3,jc4,jl0r,il0)
-               diag_blk%valid(jc3,jc4,jl0r,il0) = avg_blk%nc1a(jc3,jc4,jl0r,il0)
+            if (nam%loc_from_cor) then
+               if (mpl%msv%isnot(avg_blk%cor(jc3,jc4,jl0r,il0))) then
+                  ! Compute localization from sample correlation
+                  diag_blk%raw(jc3,jc4,jl0r,il0) = avg_blk%cor(jc3,jc4,jl0r,il0)**2/((1.0+P4)*avg_blk%cor(jc3,jc4,jl0r,il0)**2+P4)
+                  diag_blk%valid(jc3,jc4,jl0r,il0) = avg_blk%nc1a_cor(jc3,jc4,jl0r,il0)
+               else
+                  ! Missing value
+                  diag_blk%raw(jc3,jc4,jl0r,il0) = mpl%msv%valr
+                  diag_blk%valid(jc3,jc4,jl0r,il0) = mpl%msv%valr
+               end if
             else
-               ! Missing value
-               diag_blk%raw(jc3,jc4,jl0r,il0) = mpl%msv%valr
-               diag_blk%valid(jc3,jc4,jl0r,il0) = mpl%msv%valr
+               if (mpl%msv%isnot(avg_blk%m11asysq(jc3,jc4,jl0r,il0)).and.mpl%msv%isnot(avg_blk%m11sq(jc3,jc4,jl0r,il0))) then
+                  ! Compute localization asymptotic moments
+                  diag_blk%raw(jc3,jc4,jl0r,il0) = avg_blk%m11asysq(jc3,jc4,jl0r,il0)/avg_blk%m11sq(jc3,jc4,jl0r,il0)
+                  diag_blk%valid(jc3,jc4,jl0r,il0) = avg_blk%nc1a(jc3,jc4,jl0r,il0)
+               else
+                  ! Missing value
+                  diag_blk%raw(jc3,jc4,jl0r,il0) = mpl%msv%valr
+                  diag_blk%valid(jc3,jc4,jl0r,il0) = mpl%msv%valr
+               end if
             end if
          end do
       end do
