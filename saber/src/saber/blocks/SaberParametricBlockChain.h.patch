--- /home/benjaminm/code/oops-bundle/ecsaber/saber/src/saber/blocks/SaberParametricBlockChain.h.tmp.bak	2024-02-15 13:02:02.247412715 +0100
+++ /home/benjaminm/code/oops-bundle/ecsaber/saber/src/saber/blocks/SaberParametricBlockChain.h	2024-02-15 13:02:42.548806879 +0100
@@ -91,7 +91,7 @@
                        oops::FieldSets & fsetDualResEns,
                        const eckit::LocalConfiguration & covarConf,
                        const eckit::Configuration & conf)
-  : outerFunctionSpace_(geom.functionSpace()), outerVariables_(outerVars),
+  : outerFunctionSpace_(geom.geometry().functionSpace()), outerVariables_(outerVars),
   crossTimeCov_(covarConf.getString("time covariance") == "multivariate duplicated"),
   timeComm_(fset4dXb.commTime()), size4D_(fset4dXb.size()) {
   oops::Log::trace() << "SaberParametricBlockChain ctor starting" << std::endl;
@@ -113,7 +113,7 @@
   const oops::patch::Variables currentOuterVars = outerBlockChain_ ?
                              outerBlockChain_->innerVars() : outerVariables_;
   const oops::GeometryData & currentOuterGeom = outerBlockChain_ ?
-                             outerBlockChain_->innerGeometryData() : geom.generic();
+                             outerBlockChain_->innerGeometryData() : geom.geometry().generic();
 
   SaberCentralBlockParametersWrapper saberCentralBlockParamsWrapper;
   saberCentralBlockParamsWrapper.deserialize(conf.getSubConfiguration("saber central block"));
@@ -168,7 +168,7 @@
 
       for (size_t ie = 0; ie < nens; ++ie) {
         // Read ensemble member
-        oops::FieldSet3D fset(fset4dXb[0].validTime(), geom.getComm());
+        oops::FieldSet3D fset(fset4dXb[0].validTime(), geom.geometry().getComm());
         readEnsembleMember(geom, outerVariables_, ensembleConf, ie, fset);
 
         // Apply outer blocks inverse (all of them)
@@ -199,7 +199,7 @@
     oops::Log::info() << "Info     : Dual resolution setup" << std::endl;
 
     // Dual resolution setup
-    centralBlock_->dualResolutionSetup(dualResGeom.generic());
+    centralBlock_->dualResolutionSetup(dualResGeom.geometry().generic());
 
     // Ensemble configuration
     eckit::LocalConfiguration dualResEnsembleConf
@@ -217,7 +217,7 @@
 
       for (size_t ie = 0; ie < dualResNens; ++ie) {
         // Read ensemble member
-        oops::FieldSet3D fset(fset4dXb[0].validTime(), dualResGeom.getComm());
+        oops::FieldSet3D fset(fset4dXb[0].validTime(), geom.geometry().getComm());
         readEnsembleMember(dualResGeom, outerVariables_, dualResEnsembleConf, ie, fset);
 
         // Use FieldSet in the central block
@@ -248,18 +248,18 @@
     const eckit::LocalConfiguration outputEnsembleConf(covarConf, "output ensemble");
 
     // Check whether geometry grid is similar to the last outer block inner geometry
-    const bool useModelWriter = (util::getGridUid(geom.functionSpace())
+    const bool useModelWriter = (util::getGridUid(geom.geometry().functionSpace())
       == util::getGridUid(currentOuterGeom.functionSpace()));
 
     // Get ensemble size
     size_t ensembleSize = ensembleConf.getInt("ensemble size");
 
     // Estimate mean
-    oops::FieldSet3D fsetMean(fset4dXb[0].validTime(), geom.getComm());
+    oops::FieldSet3D fsetMean(fset4dXb[0].validTime(), geom.geometry().getComm());
     if (iterativeEnsembleLoading) {
       for (size_t ie = 0; ie < ensembleSize; ++ie) {
         // Read member
-        oops::FieldSet3D fsetMem(fset4dXb[0].validTime(), geom.getComm());
+        oops::FieldSet3D fsetMem(fset4dXb[0].validTime(), geom.geometry().getComm());
         readEnsembleMember(geom, activeVars, ensembleConf, ie, fsetMem);
 
         // Update mean
@@ -282,14 +282,16 @@
 
     for (size_t ie = 0; ie < ensembleSize; ++ie) {
       oops::Log::info() << "Info     : Write member " << ie << std::endl;
+      // Create variables
+      oops::Variables<MODEL> activeVarsT(templatedVarsConf(activeVars));
 
       // Increment pointer
-      oops::Increment<MODEL> dx(geom, activeVars, fset4dXb[0].validTime());
+      oops::Increment<MODEL> dx(geom, activeVarsT, fset4dXb[0].validTime());
 
       // Get ensemble member
       if (iterativeEnsembleLoading) {
         // Read ensemble member
-        oops::FieldSet3D fset(fset4dXb[0].validTime(), geom.getComm());
+        oops::FieldSet3D fset(fset4dXb[0].validTime(), geom.geometry().getComm());
         readEnsembleMember(geom, activeVars, ensembleConf, ie, fset);
 
         // Remove mean
@@ -299,10 +301,10 @@
         if (outerBlockChain_) outerBlockChain_->leftInverseMultiply(fset);
 
         // ATLAS fieldset to Increment_
-        dx.fromFieldSet(fset.fieldSet());
+        dx.increment().fromFieldSet(fset.fieldSet());
       } else {
         // ATLAS fieldset to Increment_
-        dx.fromFieldSet(fsetEns[ie].fieldSet());
+        dx.increment().fromFieldSet(fsetEns[ie].fieldSet());
       }
 
       if (useModelWriter) {
